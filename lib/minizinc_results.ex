defmodule MinizincResults do
  @moduledoc """
    Functions and data structures for working with data produced by Minizinc during runtime.
  """

  require Logger

  ############### Solver results ##################
  def get_status(%{summary: summary} = _solver_results) do
    get_status(summary)
  end

  def get_status(summary) do
    status(get_method(summary), summary[:status])
  end

  def get_method(%{summary: summary} = _solver_results) do
    get_method(summary)
  end

  def get_method(summary) do
    MinizincModel.method(summary[:model_info])
  end

  def get_solver(%{summary: summary} = _solver_results) do
    summary.solver
  end

  def get_solver_stats(%{summary: summary} = _solver_results) do
    summary.solver_stats
  end

  def get_last_solution(%{summary: summary} = _solver_results) do
    get_last_solution(summary)
  end

  def get_last_solution(summary) do
    summary[:last_solution]
  end

  def get_solution_count(%{summary: summary} = _solver_results) do
    get_solution_count(summary)
  end

  def get_solution_count(summary) do
    summary[:solution_count]
  end

  def has_solution(solver_results) do
    get_solution_count(solver_results) > 0
  end

  def get_solution_objective(solution) do
    get_solution_value(solution, "_objective")
  end

  ## Get output generated by a solver for the given solution
  ## (through 'output' model clauses).
  def get_solution_output(solution) do
    get_solution_value(solution, "_output")
  end

  ## Get solution checker output
  def get_checker_output(solution) do
    get_solution_value(solution, "_checker")
  end

  ## Get value of the variable from the solution
  def get_solution_value(solution, varname) do
    solution[:data][varname]
  end

  def get_solution_index(solution) do
    solution[:index]
  end

  def get_solutions(solver_results) do
    solver_results[:solutions]
  end

  def status(:satisfy, :all_solutions) do
    :all_solutions
  end

  def status(method, :all_solutions) when method in [:minimize, :maximize] do
    :optimal
  end

  def status(_method, status) do
    status
  end
end
